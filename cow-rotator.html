<head>
</head>
    <title>Cow rotator üêÑ</title>
    <style>
        h1 {
            font-family:'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
            text-align: center;
            color: antiquewhite;
            margin: 5px;
            text-shadow: 0px 0px 6px rgb(0, 0, 0);
        }
        h3 {
            font-family:'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
            text-align: center;
            color: antiquewhite;
            margin: 10px;
        }
        h4 {
            font-family:'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
            text-align: center;
            color: rgb(2, 34, 37);
            margin: 3px;
        }
    </style>
</head>

<body style="background-color:rgb(206, 206, 206); margin: 0px;">

<div id="pix" style="width: 100%; height:99%; margin: 0px;">
    <canvas id="canvas" width="5" height="5" style="border:1px solid #000000; box-shadow: 0px 0px 10px rgb(18,18,18); margin: 0px;">:(</canvas>
</div>

<script>

offsetX = window.innerWidth / 2;
offsetY = window.innerHeight / 2;
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
ctx.canvas.width  = window.innerWidth;
ctx.canvas.height = window.innerHeight;

let xAngle = 0
let yAngle = 0
let zAngle = 0
let angleStep = 3
let scaleFactor = 2

cube = {points : [[100,100,100],[-100,100,100],[100,100,-100],[-100,100,-100],[100,-100,100],[-100,-100,100],[100,-100,-100],[-100,-100,-100],[0,-200,0]],
    edges : [[0,1],[1,3],[2,0],[3,2],[4,5],[5,7],[6,4],[7,6],[0,4],[1,5],[2,6],[3,7],[4,8],[5,8],[6,8],[7,8]]
}


cow = {
    points : [
                [-65,90,-35],[-55,90,-35],[-55,90,-25],[-65,90,-25], //foot1
                [75,90,-35],[85,90,-35],[85,90,-25],[75,90,-25], //foot2
                [-65,40,-35],[-45,40,-35],[-45,40,-15],[-65,40,-15], //thighring1
                [65,40,-35],[85,40,-35],[85,40,-15],[65,40,-15],//thighring2
                [-65,90,35],[-55,90,35],[-55,90,25],[-65,90,25],// foot3
                [75,90,35],[85,90,35],[85,90,25],[75,90,25],// foot4
                [-65,40,35],[-45,40,35],[-45,40,15],[-65,40,15], //thighring3
                [65,40,35],[85,40,35],[85,40,15],[65,40,15],//thighring4
                [-95,-20,-20],[-95,-20,20], // neckline
                [-125,-15,-10],[-125,-15,10],[-130,-25,10],[-130,-25,-10], // nose
                [-90,-45,20],[-90,-45,-20], // top of head -line
                [-60,-15,35],[-60,-15,-35], //ontop-front-line
                [85,-15,35],[85,-15,-35], //ontop-back-line
                [85,-4,-4],[85,4,4], // buttline1
                [85,-4,4],[85,4,-4] // buttline2
                ], 



    edges : [
                [0,1],[1,2],[2,3],[3,0], // foot1
                [4,5],[5,6],[6,7],[7,4], // foot2
                [8,9],[9,10],[10,11],[11,8], //thighring1
                [0,8],[1,9],[2,10],[3,11], //foot1 to thighring 1
                [12,13],[13,14],[14,15],[15,12], // thighring 2
                [4,12],[5,13],[6,14],[7,15], // foot2 to thighring2
                [16,17],[17,18],[18,19],[19,16], // foot3
                [20,21],[21,22],[22,23],[23,20], // foot4
                [24,25],[25,26],[26,27],[27,24], // thighring3
                [28,29],[29,30],[30,31],[31,28], //thighring4
                [16,24],[17,25],[18,26],[19,27], // foot3 to thighring3
                [20,28],[21,29],[22,30],[23,31], // foot4 to thighring4
                [9,12],[14,30],[28,25],[27,11], // undercarriage rectangle (linking thighrings)
                [32,33], // neckline
                [24,33],[8,32], //front of undercarriage to neckline
                [34,35],[35,36],[36,37],[37,34], // nose
                [32,34],[33,35], // neckline to bottom of nose
                [38,39],// top of head 
                [36,38],[37,39],// top of head to top of nose
                [40,41], //ontop-front-line
                [38,40],[39,41], // top of head to ontop-front-line
                [42,43], //ontop-back-line
                [40,42],[41,43], // ontop-front line to ontop-back line
                [13,43],[29,42], // ontop-back line to thighring2 and 4
                [8,41],[24,40],// ontop-front line to thighring1 and 3
                [44,45],[46,47]// butt
            ]
}


model = JSON.parse(JSON.stringify(cow));

function drawModel(mod){
    ctx.canvas.width = ctx.canvas.width;
    ctx.fillStyle = "red"
    ctx.fillRect(offsetX-2,offsetY-2,4,4)
    for(let i=0;i<mod.edges.length;i++){
        
        side = mod.edges[i];
        point0 = mod.points[side[0]]; point1 = mod.points[side[1]];
        
        x0=point0[0]*scaleFactor;y0=point0[1]*scaleFactor;
        x1=point1[0]*scaleFactor;y1=point1[1]*scaleFactor;
        
        ctx.moveTo(x0+offsetX,y0+offsetY);
        ctx.lineTo(x1+offsetX,y1+offsetY);
        ctx.lineWidth = 1;
        ctx.stroke();
    }
}

function rotateAllPoints(obj,x,y,z){
    x *= Math.PI/180;
    y *= Math.PI/180;
    z *= Math.PI/180;
    for(let i=0;i<obj.points.length;i++){
    obj.points[i] = rotateAroundX(obj.points[i],x);
    obj.points[i] = rotateAroundY(obj.points[i],y);
    obj.points[i] = rotateAroundZ(obj.points[i],z);
    }
    return obj
}


function matrixMultiplication(A,B){
    if(A[0].length != B.length){throw new Error("Invalid dimensions for matrices :(")}
    /*
    Stolen from the second answer here :
    https://stackoverflow.com/questions/27205018/multiply-2-matrices-in-javascript
    Actual source is not accessible anymore.
    */
    var result = [];
    for (var i = 0; i < A.length; i++) {
        result[i] = [];
        for (var j = 0; j < B[0].length; j++) {
            var sum = 0;
            for (var k = 0; k < A[0].length; k++) {
                sum += A[i][k] * B[k][j];
            }
            result[i][j] = sum;
        }
    }
    return result;
}

function rotateAroundZ(point,angle){
    pointT = [[point[0]],[point[1]],[point[2]]];
    zRot = [[Math.cos(angle),-Math.sin(angle),0],[Math.sin(angle),Math.cos(angle),0],[0,0,1]];
    rotatedT = matrixMultiplication(zRot,pointT);
    rotated = [rotatedT[0][0],rotatedT[1][0],rotatedT[2][0]]
    return rotated
}
function rotateAroundY(point,angle){
    pointT = [[point[0]],[point[1]],[point[2]]];
    yRot = [[Math.cos(angle),0,Math.sin(angle)],[0,1,0],[-Math.sin(angle),0,Math.cos(angle)]];
    rotatedT = matrixMultiplication(yRot,pointT);
    rotated = [rotatedT[0][0],rotatedT[1][0],rotatedT[2][0]]
    return rotated
}
function rotateAroundX(point,angle){
    pointT = [[point[0]],[point[1]],[point[2]]];
    xRot = [[1,0,0],[0,Math.cos(angle),-Math.sin(angle)],[0,Math.sin(angle),Math.cos(angle)]];
    rotatedT = matrixMultiplication(xRot,pointT);
    rotated = [rotatedT[0][0],rotatedT[1][0],rotatedT[2][0]]
    return rotated
}

window.addEventListener("deviceorientation", handleOrientation, true);
function handleOrientation(event) {
    //let absolute = event.absolute;
    // alpha SPINNING ON TABLE goes 0 - 360 -> 0
    // beta LIFTING TOWARDS YOUR FACE goes flat: 0 - 90 (portrait) - 180 (upside down) -> -180 - 0
    // gamma FLIPPING SIDEWAYS goes leftfacing: -90 - 0 - 90 -> -90 - 0 (upside down) - 90 -> -90 (left facing again)
    alpha = event.alpha
    beta = event.beta
    gamma = event.gamma
    if(beta < 180){beta = 180+180+beta;} // actually dont think this is needed coz of the mod later
    if(gamma<0){alpha +=180;beta+=180;}

    zAngle  = (alpha + 360)%360
    xAngle   = (beta + 360)%360 //-90 inside
    yAngle   = (gamma + 360)%360

    modelCopy = JSON.parse(JSON.stringify(model));
    drawModel(rotateAllPoints(modelCopy,xAngle,yAngle,zAngle))
}

/*
document.body.addEventListener("mousemove", function (e) {
    console.log(e.clientX,e.clientY);
    ctx.fillRect(e.clientX-2,e.clientY-2,4,4)
})
*/

document.addEventListener('keydown', function(event){
    
    if (["a","d"].includes(event.key)){
        yAngle += {"a":angleStep,"d":-angleStep}[event.key];
    }
    if (["w","s"].includes(event.key)){
        xAngle += {"w":-angleStep,"s":angleStep}[event.key];
    }
    if (["q","e"].includes(event.key)){
        zAngle += {"q":-angleStep,"e":+angleStep}[event.key];
    }

    modelCopy = JSON.parse(JSON.stringify(model));
    drawModel(rotateAllPoints(modelCopy,xAngle,yAngle,zAngle))
})

window.addEventListener('load', function(event){
    // flip it around to start
    // Honestly no clue why the thing is rotating 90 by itself in the first place
    // i must be projecting it wrong? anyway this is a small fix LOL
    //model = rotateAllPoints(model,90,0,0)
    drawModel(model);
    }
  );

</script>
